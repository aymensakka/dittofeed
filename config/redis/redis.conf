# Redis Production Configuration for Dittofeed Enterprise Multitenancy
# Optimized for workspace-scoped caching and high performance

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

# Bind to all interfaces in Docker network
bind 0.0.0.0

# Port configuration
port 6379

# TCP listen backlog
tcp-backlog 511

# TCP keepalive
tcp-keepalive 300

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# Require password authentication
requirepass your_redis_password_here

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG "CONFIG_b2f8c9e1a4d6"
rename-command SHUTDOWN "SHUTDOWN_a8f3d5c7b9e2"
rename-command DEBUG ""
rename-command EVAL ""

# Protected mode (additional security layer)
protected-mode yes

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Maximum memory usage (adjust based on your server)
maxmemory 512mb

# Memory eviction policy - optimized for cache workloads
maxmemory-policy allkeys-lru

# Memory sampling for LRU eviction
maxmemory-samples 5

# =============================================================================
# PERSISTENCE CONFIGURATION
# =============================================================================

# RDB Snapshotting - balanced between performance and durability
save 900 1     # Save if at least 1 key changed in 900 seconds
save 300 10    # Save if at least 10 keys changed in 300 seconds
save 60 10000  # Save if at least 10000 keys changed in 60 seconds

# RDB compression
rdbcompression yes

# RDB checksum verification
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory
dir /data

# Stop writes on RDB errors
stop-writes-on-bgsave-error yes

# AOF persistence (disabled for cache use case to improve performance)
appendonly no

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

# Log level (debug, verbose, notice, warning)
loglevel notice

# Log file location
logfile ""

# Syslog enabled
syslog-enabled no

# =============================================================================
# CLIENT CONFIGURATION
# =============================================================================

# Maximum number of client connections
maxclients 10000

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client timeout (0 = disabled)
timeout 300

# =============================================================================
# PERFORMANCE OPTIMIZATION
# =============================================================================

# Disable transparent huge pages warning
always-show-logo no

# Hash table resize optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List optimization
list-max-ziplist-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512

# Sorted set optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# Stream optimization
stream-node-max-bytes 4096
stream-node-max-entries 100

# =============================================================================
# THREADING CONFIGURATION (Redis 6+)
# =============================================================================

# I/O threads for network operations
io-threads 4
io-threads-do-reads yes

# =============================================================================
# SLOW LOG CONFIGURATION
# =============================================================================

# Log queries slower than 10 milliseconds
slowlog-log-slower-than 10000

# Keep last 128 slow queries
slowlog-max-len 128

# =============================================================================
# LATENCY MONITORING
# =============================================================================

# Latency monitoring threshold
latency-monitor-threshold 100

# =============================================================================
# MULTITENANCY OPTIMIZATIONS
# =============================================================================

# Database count (using DB 0 for tenant cache with prefixes)
databases 1

# Key expiration precision
hz 10

# =============================================================================
# REPLICATION CONFIGURATION (for master-slave setup)
# =============================================================================

# Replica serve stale data during sync
replica-serve-stale-data yes

# Replica read-only mode
replica-read-only yes

# Replica priority
replica-priority 100

# Minimum replicas settings (uncomment for HA setup)
# min-replicas-to-write 1
# min-replicas-max-lag 30

# =============================================================================
# CLUSTER CONFIGURATION (disabled for single-instance)
# =============================================================================

# cluster-enabled no

# =============================================================================
# MODULES AND EXTENSIONS
# =============================================================================

# No modules loaded by default

# =============================================================================
# SENTINEL CONFIGURATION (for HA setup)
# =============================================================================

# Sentinel configuration would go in a separate sentinel.conf file

# =============================================================================
# NOTIFICATIONS AND EVENTS
# =============================================================================

# Keyspace notifications (disabled for performance)
notify-keyspace-events ""

# =============================================================================
# ADVANCED CONFIGURATION
# =============================================================================

# Dynamic HZ adjustment
dynamic-hz yes

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# Jemalloc background thread
jemalloc-bg-thread yes

# =============================================================================
# DEBUGGING AND DEVELOPMENT
# =============================================================================

# Disable debugging features in production
# debug-mode no

# =============================================================================
# WORKSPACE-SPECIFIC CONFIGURATIONS
# =============================================================================

# These are handled by the application layer:
# - Workspace-scoped key prefixes
# - TTL management per workspace
# - Cache invalidation patterns
# - Quota enforcement

# =============================================================================
# MONITORING INTEGRATION
# =============================================================================

# Expose Redis metrics for Prometheus
# (This requires redis_exporter sidecar container)

# =============================================================================
# BACKUP AND RECOVERY
# =============================================================================

# RDB save location
# Handled by Docker volume mounts

# =============================================================================
# SPECIAL CONFIGURATION NOTES
# =============================================================================

# 1. Password should be changed from default
# 2. Memory limit should be adjusted based on server capacity
# 3. For production HA, consider Redis Sentinel or Cluster
# 4. Monitor memory usage and hit rates
# 5. Adjust key expiration based on workload patterns

# =============================================================================
# ENVIRONMENT-SPECIFIC OVERRIDES
# =============================================================================

# These can be overridden via environment variables in Docker:
# - REDIS_PASSWORD
# - REDIS_MAXMEMORY
# - REDIS_SAVE_INTERVAL